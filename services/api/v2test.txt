func TestBuilderApiSubmitNewBlockOptimisticV2(t *testing.T) {
	testCases := []struct {
		description     string
		wantStatus      common.BuilderStatus
		simulationError error
		expectDemotion  bool
		httpCode        uint64
		blockValue      uint64
	}{
		{
			description: "success",
			wantStatus: common.BuilderStatus{
				IsOptimistic: true,
				IsHighPrio:   true,
			},
			simulationError: nil,
			expectDemotion:  false,
			httpCode:        200, // success
			blockValue:      collateral - 1,
		},
	}

	for _, tc := range testCases {
		t.Run(tc.description, func(t *testing.T) {
			pubkey, secretkey, backend := startTestBackend(t)
			backend.relay.optimisticSlot = slot
			backend.relay.capellaEpoch = 1
			var randaoHash boostTypes.Hash
			err := randaoHash.FromSlice([]byte(randao))
			require.NoError(t, err)
			withRoot, err := ComputeWithdrawalsRoot([]*consensuscapella.Withdrawal{})
			require.NoError(t, err)
			backend.relay.payloadAttributes[emptyHash] = payloadAttributesHelper{
				slot:            slot,
				withdrawalsRoot: withRoot,
				payloadAttributes: beaconclient.PayloadAttributes{
					PrevRandao: randaoHash.String(),
				},
			}
			rr := runOptimisticBlockSubmissionV2(t, blockRequestOpts{
				secretkey:  secretkey,
				pubkey:     *pubkey,
				blockValue: tc.blockValue,
				domain:     backend.relay.opts.EthNetDetails.DomainBuilder,
			}, tc.simulationError, backend)

			// Check http code.
			require.Equal(t, uint64(rr.Code), tc.httpCode)
		})
	}
}

func runOptimisticBlockSubmissionV2(t *testing.T, opts blockRequestOpts, simErr error, backend *testBackend) *httptest.ResponseRecorder {
	backend.relay.blockSimRateLimiter = &MockBlockSimulationRateLimiter{
		simulationError: simErr,
	}

	req := common.TestBuilderSubmitBlockRequestV2(opts.secretkey, getTestBidTrace(opts.pubkey, opts.blockValue))
	rr := backend.request(http.MethodPost, pathSubmitNewBlockV2, &req)

	// Let updates happen async.
	time.Sleep(100 * time.Millisecond)
	return rr
}

reqSt := `"Message": {"slot": "6300107", "parent_hash": "0xacc14efa419bb603969ca5a0f216f3d56be6f0f41f93a770744d591ad94251f8", "block_hash": "0x740ccea61484cc83764efd2b3c12e156c218e7cbfd745d211bd423640ee6d1ff", "builder_pubkey": "0x8e6df6e0a9ca3fd89db2aa2f3daf77722dc4fbcd15e285ed7d9560fdf07b7d69ba504add4cc12ac999b8094ff30ed06c", "proposer_pubkey": "0x98e690ddc822a8c9c26e110414b159f76e7567a4d6ce3ac1b75e773ee016a4903a829b9c38623e687a5753044021d461", "proposer_fee_recipient": "0x58cb0d9d6fa1ebd9b4076a59e7d0471322f7bbb3", "gas_limit": "30000000", "gas_used": "12128256", "value": "100739950771057674"}, "ExecutionPayloadHeader": {"parent_hash": "0xacc14efa419bb603969ca5a0f216f3d56be6f0f41f93a770744d591ad94251f8", "fee_recipient": "0x333333f332a06ecb5d20d35da44ba07986d6e203", "state_root": "0x4a695f3b105ca0293f0c531014d8a841fbd7a4b47d7b6208dd7270a2f57363cd", "receipts_root": "0x7fa45674d1ec9c5b1e6f91aaf099e28ec59af7467db0648a357eed8de9f56897", "logs_bloom": "0x2061df24c29b1a5d881ecfe2833046e223f945a9202ce4c843cfb97cfec7a9c2d81f7bd8bd7a107ac551a118f8784d3a8a259c85ce48ef4dab0402cc643cb48724a0817b462aad0c6c4f422b69d2f9ee10dc15809aeebd85bd5058b4b3a66f8186a028ded777ab176e487409d8216a65085ff37e8d435c08f71b16f2a76c63fe82bd235c9b499bd94eef42f42700370e85843639754cae7a3c4b656e49d108b39e9cc7c32f8b6e69828ac0f4e9d30c86e626d2bd51fec0b2d4e986ff412a60652fd0417e538a166c9759468b848d3d56c96c01ee03643659b514198a1d766615117bea1c7508c8bf12f541ce318d0fda989d583a9d0a46e0377913b78c8d6cc6", "prev_randao": "0x0c1750bebf5e38c3548577fbf47472faaa09496a9e1835c5336cc4ad1eb87392", "block_number": "17123238", "gas_limit": "30000000", "gas_used": "12128256", "timestamp": "1682425307", "extra_data": "0x7273796e632d6275696c6465722e78797a", "base_fee_per_gas": "35760743079", "block_hash": "0x740ccea61484cc83764efd2b3c12e156c218e7cbfd745d211bd423640ee6d1ff", "transactions_root": "0x6b136333a5962cacf80aca4d7ce8dc8d93ce8628b3a98cd0a0a713669d34bc1f", "withdrawals_root": "0x786163f2462f32f87f2c3a075da65316c704521c7853f735cbba4e50d84492a4"}, "Signature": [170, 176, 43, 189, 163, 182, 59, 112, 57, 7, 17, 45, 88, 95, 109, 230, 180, 152, 89, 89, 166, 146, 193, 56, 120, 245, 54, 179, 196, 77, 115, 123, 164, 87, 255, 32, 173, 136, 143, 134, 156, 168, 162, 252, 205, 156, 13, 121, 8, 167, 223, 143, 125, 66, 58, 72, 249, 5, 251, 182, 35, 197, 32, 207, 103, 126, 65, 157, 228, 98, 114, 234, 235, 126, 25, 99, 70, 46, 228, 148, 232, 204, 175, 241, 70, 0, 132, 172, 34, 19, 146, 35, 128, 226, 52, 229]}`

// reqSt := `{"Message":{"slot":"41","parent_hash":"0x0000000000000000000000000000000000000000000000000000000000000000","block_hash":"0x0000000000000000000000000000000000000000000000000000000000000000","builder_pubkey":"0x919486e87e1028f4550a5524d715e2c395ab89e7516b2547ebd964dddfc63d830f7dd1717650bfa9eb749e7dc9d8b235","proposer_pubkey":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","proposer_fee_recipient":"0x0200000000000000000000000000000000000000","gas_limit":"0","gas_used":"0","value":"999"},"ExecutionPayloadHeader":{"parent_hash":"0x0000000000000000000000000000000000000000000000000000000000000000","fee_recipient":"0x0000000000000000000000000000000000000000","state_root":"0x0000000000000000000000000000000000000000000000000000000000000000","receipts_root":"0x0000000000000000000000000000000000000000000000000000000000000000","logs_bloom":"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","prev_randao":"0x3031323334353637383930313233343536373839303132333435363738393031","block_number":"0","gas_limit":"0","gas_used":"0","timestamp":"492","extra_data":"0x","base_fee_per_gas":"0","block_hash":"0x0000000000000000000000000000000000000000000000000000000000000000","transactions_root":"0x0000000000000000000000000000000000000000000000000000000000000000","withdrawals_root":"0x792930bbd5baac43bcc798ee49aa8185ef76bb3b44ba62b91d86ae569e4bb535"},"Signature":"[180, 201, 168, 53, 240, 80, 86, 193, 86, 127, 226, 37, 149, 153, 49, 21, 134, 16, 4, 43, 69, 125, 197, 251, 8, 29, 0, 137, 72, 223, 42, 213, 197, 48, 7, 155, 189, 174, 188, 73, 13, 23, 5, 207, 236, 28, 251, 164, 4, 68, 175, 86, 106, 2, 220, 123, 87, 246, 65, 195, 27, 5, 31, 193, 153, 142, 45, 227, 22, 24, 64, 148, 187, 169, 248, 242, 131, 185, 55, 158, 117, 44, 239, 86, 7, 9, 63, 71, 61, 43, 116, 101, 219, 176, 228, 244]","Transactions":[],"Withdrawals":null}`
	reqSt := `{"Message": {"slot": "6300107", "parent_hash": "0xacc14efa419bb603969ca5a0f216f3d56be6f0f41f93a770744d591ad94251f8", "block_hash": "0x740ccea61484cc83764efd2b3c12e156c218e7cbfd745d211bd423640ee6d1ff", "builder_pubkey": "0x8e6df6e0a9ca3fd89db2aa2f3daf77722dc4fbcd15e285ed7d9560fdf07b7d69ba504add4cc12ac999b8094ff30ed06c", "proposer_pubkey": "0x98e690ddc822a8c9c26e110414b159f76e7567a4d6ce3ac1b75e773ee016a4903a829b9c38623e687a5753044021d461", "proposer_fee_recipient": "0x58cb0d9d6fa1ebd9b4076a59e7d0471322f7bbb3", "gas_limit": "30000000", "gas_used": "12128256", "value": "100739950771057674"}, "ExecutionPayloadHeader": {"parent_hash": "0xacc14efa419bb603969ca5a0f216f3d56be6f0f41f93a770744d591ad94251f8", "fee_recipient": "0x333333f332a06ecb5d20d35da44ba07986d6e203", "state_root": "0x4a695f3b105ca0293f0c531014d8a841fbd7a4b47d7b6208dd7270a2f57363cd", "receipts_root": "0x7fa45674d1ec9c5b1e6f91aaf099e28ec59af7467db0648a357eed8de9f56897", "logs_bloom": "0x2061df24c29b1a5d881ecfe2833046e223f945a9202ce4c843cfb97cfec7a9c2d81f7bd8bd7a107ac551a118f8784d3a8a259c85ce48ef4dab0402cc643cb48724a0817b462aad0c6c4f422b69d2f9ee10dc15809aeebd85bd5058b4b3a66f8186a028ded777ab176e487409d8216a65085ff37e8d435c08f71b16f2a76c63fe82bd235c9b499bd94eef42f42700370e85843639754cae7a3c4b656e49d108b39e9cc7c32f8b6e69828ac0f4e9d30c86e626d2bd51fec0b2d4e986ff412a60652fd0417e538a166c9759468b848d3d56c96c01ee03643659b514198a1d766615117bea1c7508c8bf12f541ce318d0fda989d583a9d0a46e0377913b78c8d6cc6", "prev_randao": "0x0c1750bebf5e38c3548577fbf47472faaa09496a9e1835c5336cc4ad1eb87392", "block_number": "17123238", "gas_limit": "30000000", "gas_used": "12128256", "timestamp": "1682425307", "extra_data": "0x7273796e632d6275696c6465722e78797a", "base_fee_per_gas": "35760743079", "block_hash": "0x740ccea61484cc83764efd2b3c12e156c218e7cbfd745d211bd423640ee6d1ff", "transactions_root": "0x6b136333a5962cacf80aca4d7ce8dc8d93ce8628b3a98cd0a0a713669d34bc1f", "withdrawals_root": "0x786163f2462f32f87f2c3a075da65316c704521c7853f735cbba4e50d84492a4"}, "Signature": "[170, 176, 43, 189, 163, 182, 59, 112, 57, 7, 17, 45, 88, 95, 109, 230, 180, 152, 89, 89, 166, 146, 193, 56, 120, 245, 54, 179, 196, 77, 115, 123, 164, 87, 255, 32, 173, 136, 143, 134, 156, 168, 162, 252, 205, 156, 13, 121, 8, 167, 223, 143, 125, 66, 58, 72, 249, 5, 251, 182, 35, 197, 32, 207, 103, 126, 65, 157, 228, 98, 114, 234, 235, 126, 25, 99, 70, 46, 228, 148, 232, 204, 175, 241, 70, 0, 132, 172, 34, 19, 146, 35, 128, 226, 52, 229]"}`

	reqSt := `{"Message":{"slot":"41","parent_hash":"0x0000000000000000000000000000000000000000000000000000000000000000","block_hash":"0x0000000000000000000000000000000000000000000000000000000000000000","builder_pubkey":"0x919486e87e1028f4550a5524d715e2c395ab89e7516b2547ebd964dddfc63d830f7dd1717650bfa9eb749e7dc9d8b235","proposer_pubkey":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","proposer_fee_recipient":"0x0200000000000000000000000000000000000000","gas_limit":"0","gas_used":"0","value":"999"},"ExecutionPayloadHeader":{"parent_hash":"0x0000000000000000000000000000000000000000000000000000000000000000","fee_recipient":"0x0000000000000000000000000000000000000000","state_root":"0x0000000000000000000000000000000000000000000000000000000000000000","receipts_root":"0x0000000000000000000000000000000000000000000000000000000000000000","logs_bloom":"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","prev_randao":"0x3031323334353637383930313233343536373839303132333435363738393031","block_number":"0","gas_limit":"0","gas_used":"0","timestamp":"492","extra_data":"0x","base_fee_per_gas":"0","block_hash":"0x0000000000000000000000000000000000000000000000000000000000000000","transactions_root":"0x0000000000000000000000000000000000000000000000000000000000000000","withdrawals_root":"0x792930bbd5baac43bcc798ee49aa8185ef76bb3b44ba62b91d86ae569e4bb535"},"Signature":[180, 201, 168, 53, 240, 80, 86, 193, 86, 127, 226, 37, 149, 153, 49, 21, 134, 16, 4, 43, 69, 125, 197, 251, 8, 29, 0, 137, 72, 223, 42, 213, 197, 48, 7, 155, 189, 174, 188, 73, 13, 23, 5, 207, 236, 28, 251, 164, 4, 68, 175, 86, 106, 2, 220, 123, 87, 246, 65, 195, 27, 5, 31, 193, 153, 142, 45, 227, 22, 24, 64, 148, 187, 169, 248, 242, 131, 185, 55, 158, 117, 44, 239, 86, 7, 9, 63, 71, 61, 43, 116, 101, 219, 176, 228, 244],"Transactions":[],"Withdrawals":null}`
	reqSt := `{"Message": {"slot": "6300107", "parent_hash": "0xacc14efa419bb603969ca5a0f216f3d56be6f0f41f93a770744d591ad94251f8", "block_hash": "0x740ccea61484cc83764efd2b3c12e156c218e7cbfd745d211bd423640ee6d1ff", "builder_pubkey": "0x8e6df6e0a9ca3fd89db2aa2f3daf77722dc4fbcd15e285ed7d9560fdf07b7d69ba504add4cc12ac999b8094ff30ed06c", "proposer_pubkey": "0x98e690ddc822a8c9c26e110414b159f76e7567a4d6ce3ac1b75e773ee016a4903a829b9c38623e687a5753044021d461", "proposer_fee_recipient": "0x58cb0d9d6fa1ebd9b4076a59e7d0471322f7bbb3", "gas_limit": "30000000", "gas_used": "12128256", "value": "100739950771057674"}, "ExecutionPayloadHeader": {"parent_hash": "0xacc14efa419bb603969ca5a0f216f3d56be6f0f41f93a770744d591ad94251f8", "fee_recipient": "0x333333f332a06ecb5d20d35da44ba07986d6e203", "state_root": "0x4a695f3b105ca0293f0c531014d8a841fbd7a4b47d7b6208dd7270a2f57363cd", "receipts_root": "0x7fa45674d1ec9c5b1e6f91aaf099e28ec59af7467db0648a357eed8de9f56897", "logs_bloom": "0x2061df24c29b1a5d881ecfe2833046e223f945a9202ce4c843cfb97cfec7a9c2d81f7bd8bd7a107ac551a118f8784d3a8a259c85ce48ef4dab0402cc643cb48724a0817b462aad0c6c4f422b69d2f9ee10dc15809aeebd85bd5058b4b3a66f8186a028ded777ab176e487409d8216a65085ff37e8d435c08f71b16f2a76c63fe82bd235c9b499bd94eef42f42700370e85843639754cae7a3c4b656e49d108b39e9cc7c32f8b6e69828ac0f4e9d30c86e626d2bd51fec0b2d4e986ff412a60652fd0417e538a166c9759468b848d3d56c96c01ee03643659b514198a1d766615117bea1c7508c8bf12f541ce318d0fda989d583a9d0a46e0377913b78c8d6cc6", "prev_randao": "0x0c1750bebf5e38c3548577fbf47472faaa09496a9e1835c5336cc4ad1eb87392", "block_number": "17123238", "gas_limit": "30000000", "gas_used": "12128256", "timestamp": "1682425307", "extra_data": "0x7273796e632d6275696c6465722e78797a", "base_fee_per_gas": "35760743079", "block_hash": "0x740ccea61484cc83764efd2b3c12e156c218e7cbfd745d211bd423640ee6d1ff", "transactions_root": "0x6b136333a5962cacf80aca4d7ce8dc8d93ce8628b3a98cd0a0a713669d34bc1f", "withdrawals_root": "0x786163f2462f32f87f2c3a075da65316c704521c7853f735cbba4e50d84492a4"}, "Signature": [170, 176, 43, 189, 163, 182, 59, 112, 57, 7, 17, 45, 88, 95, 109, 230, 180, 152, 89, 89, 166, 146, 193, 56, 120, 245, 54, 179, 196, 77, 115, 123, 164, 87, 255, 32, 173, 136, 143, 134, 156, 168, 162, 252, 205, 156, 13, 121, 8, 167, 223, 143, 125, 66, 58, 72, 249, 5, 251, 182, 35, 197, 32, 207, 103, 126, 65, 157, 228, 98, 114, 234, 235, 126, 25, 99, 70, 46, 228, 148, 232, 204, 175, 241, 70, 0, 132, 172, 34, 19, 146, 35, 128, 226, 52, 229]}`
