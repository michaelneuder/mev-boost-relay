package api

import (
	"encoding/json"
	"testing"

	boostTypes "github.com/flashbots/go-boost-utils/types"
	"github.com/flashbots/mev-boost-relay/common"
	"github.com/stretchr/testify/require"
)

const (
	proposerPubkey = "0x960c2f877337b81561b7cfbfb22e4d60599a37aa3590b9f5f9dd3d363d22a964f02d4e8eb86704b06aa5f8516e34d199"
	signed         = `{"message":{"slot":"6137846","proposer_index":"552061","parent_root":"0x0000000000000000000000000000000000000000000000000000000000000000","state_root":"0x0000000000000000000000000000000000000000000000000000000000000000","body":{"randao_reveal":"0xb174ccab699335097701dad2b92948cd213d056a91d63dbeed8fc2148d1723a8aaaf1e4099eb58954f493f72310fc18d04728165296563b54b7b9e6776cb0deee409573df1bee3052e24560b0f3a6dbd7ccd00d570711e961388bcf0238d8998","eth1_data":{"deposit_root":"0x0000000000000000000000000000000000000000000000000000000000000000","deposit_count":"0","block_hash":"0x0000000000000000000000000000000000000000000000000000000000000000"},"graffiti":"0x0000000000000000000000000000000000000000000000000000000000000000","proposer_slashings":[],"attester_slashings":[],"attestations":[],"deposits":[],"voluntary_exits":[],"sync_aggregate":{"sync_committee_bits":"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","sync_committee_signature":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"},"execution_payload_header":{"parent_hash":"0x99151b8bd4ac95f5ff378591b1b8228754c8056700f60919966a3bbb966918b8","fee_recipient":"0x0000000000000000000000000000000000000000","state_root":"0x263ac177f4b1e4095bd445ee706cfcdda401d0b2da4dc98296f6142c00cdfa6f","receipts_root":"0x5a544545548387e6db411264b745b2cb853f65ad5ba5bd2d04d9d4e60826c212","logs_bloom":"0x66ea21200c848263b0240c21840106e54311048e08222c64504d16a12141a4a02614470986899820238193028c4a013492010117d88e28018201e00813b238050a52849ae896088cb92367c8f218293185a0208a82d8481049081e20f190080c9fa20506238a00270095851d494228a9d71186048151041c560201510e1e80dcb1442254c3440861a94781c00767112609804005a718e20c5228404a431a2b1a8b48e9c103827565731e08d659be0c804ec32881238032124233261ec6ef2014463604260108416a8c8262a201cc3cc04180caaa9c2828d8889104e21808a040c077274b81c24a3c5a8d0088248bb6b2c0389030c22e00701045398480385115","prev_randao":"0xb4a0e152004f423e2f554b8eb5dbdd512bb3698405d19f5d07dfe87d5106f7ed","block_number":"16964664","gas_limit":"30000000","gas_used":"12349025","timestamp":"1680478175","extra_data":"0x6279206275696c64657230783639","base_fee_per_gas":"16720166622","block_hash":"0xe394671c771f5ab3fd7ea3dd61b527cf8c481e90acca1afaa29aa2bb81069452","transactions_root":"0x3c1ca26ccbd732ec6f94fc4d539d6ff0e3694b79db7058ab16d412b983a3caad"}}},"signature":"0xb544eaa34654372143d0442fbba6713d978f780da85503b2a070998970867b4936e884c9f948d51c6e08f6c927f0cd4d0a334e4f04404876e08863e73d8add1b3949fd911eb386fa24ea4c1dc062564b0af8a2f95e8940737f958c8baa584cd6"}`
)

func TestSignature(t *testing.T) {
	d, err := common.NewEthNetworkDetails("mainnet")
	require.Nil(t, err)

	bellatrix := new(boostTypes.SignedBlindedBeaconBlock)
	err = json.Unmarshal([]byte(signed), &bellatrix)
	require.Nil(t, err)

	payload := new(common.SignedBlindedBeaconBlock)
	payload.Bellatrix = bellatrix

	pk, err := boostTypes.HexToPubkey(proposerPubkey)
	require.Nil(t, err)

	ok, err := boostTypes.VerifySignature(payload.Message(), d.DomainBeaconProposerBellatrix, pk[:], payload.Signature())
	require.Nil(t, err)
	require.True(t, ok)
}
